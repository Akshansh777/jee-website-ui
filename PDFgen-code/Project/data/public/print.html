<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>JEE Society Diagnostic Report</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<style>
  body { background:#f4f6fb; font-family: -apple-system, BlinkMacSystemFont, Inter, Segoe UI, Roboto, Arial; padding:40px 0; }
  .container { width: 820px; margin: auto; background:white; padding:32px 40px; border-radius:14px; box-shadow:0 15px 35px rgba(0,0,0,0.06); }
  .header-title { font-size:22px; font-weight:900; color: #111; }
  .meta { font-size:12px; color:#666; margin-top:4px; }
  .section { margin-top:28px; padding-bottom:18px; border-bottom:1px solid #eee; }
  .section h2 { font-size:18px; margin-bottom:12px; color: #333; font-weight: 700; }
  
  /* Shaina's Card Design */
  .card { margin-top:14px; padding:18px; background:#fffaf3; border-radius:12px; border:1px solid #ffd6a5; }
  .card h3 { margin:0 0 6px; font-size:15px; color: #d97706; font-weight: 700; }
  .card div { font-size: 14px; line-height: 1.6; color: #444; }

  .graph-row { display: flex; gap: 20px; margin-top: 15px; }
  .graph-box { flex: 1; padding:14px; background:#fafafa; border-radius:10px; border:1px solid #e6e6e6; text-align: center; }
  .small { font-size: 12px; color: #888; margin-bottom: 8px; font-weight: 600; text-transform: uppercase; }
  
  .speedometer { width: 100%; height: auto; max-width: 400px; margin:auto; display: block; }
  .footer-text { text-align:center; font-size:10px; margin-top:30px; color:#999; }
</style>
</head>
<body>

<div class="container">
  <div class="header">
    <div class="header-title">JEE Possibility Diagnostic Report</div>
    <div class="meta">
      Student: <span id="studentName">Student</span><br>
      Generated: <span id="generatedAt"></span>
    </div>
  </div>

  <div id="contentArea"></div>

  <div class="footer-text">
    This is a personalised psychological + performance diagnostic generated using validated preparation intelligence models.
  </div>
</div>

<script>
// --- 1. SMART HELPERS ---
function get(S, qId) {
  // Automatically finds A, B, C, or D. If missing, shows a polite error.
  const snippet = S[`${qId}_A`] || S[`${qId}_B`] || S[`${qId}_C`] || S[`${qId}_D`];
  return snippet ? snippet.mentor_note : "<span style='color:#999; font-style:italic'>No data available for this section.</span>";
}

function card(title, text){
  return `<div class="card"><h3>${title}</h3><div>${text}</div></div>`;
}

// --- 2. DYNAMIC GRAPHS ---
function drawLineGraph(canvas, color, score) {
  if(!canvas) return;
  const ctx = canvas.getContext("2d");
  ctx.clearRect(0,0,200,180); 
  
  // Grid lines
  ctx.strokeStyle = "#eee"; ctx.lineWidth = 1;
  ctx.beginPath(); ctx.moveTo(20,40); ctx.lineTo(180,40); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(20,100); ctx.lineTo(180,100); ctx.stroke();

  // The Graph Line
  ctx.strokeStyle = color; ctx.lineWidth = 4; ctx.lineCap = "round";
  ctx.beginPath();
  
  // Calculate Height based on score (Higher score = Higher Y position)
  // Map 0-100 score to Canvas Y coordinates (160 is low, 40 is high)
  const yPos = 160 - (score * 1.2); 
  
  ctx.moveTo(20, 160); // Start bottom left
  ctx.lineTo(180, Math.max(20, yPos)); // Go to Score
  ctx.stroke();
  
  // Dot
  ctx.fillStyle = color; ctx.beginPath();
  ctx.arc(180, Math.max(20, yPos), 6, 0, 2*Math.PI); ctx.fill();
}

function drawSpeedometer(value){
  const canvas = document.getElementById("mindGauge");
  if(!canvas) return;
  const ctx = canvas.getContext("2d");
  ctx.clearRect(0,0,400,200);

  const start = Math.PI;
  const end = 2 * Math.PI;

  // Background Arch
  ctx.lineWidth = 20; ctx.strokeStyle = "#f0f0f0"; ctx.lineCap = "round";
  ctx.beginPath(); ctx.arc(200, 180, 100, start, end); ctx.stroke();

  // Active Arch (Color changes by score)
  const score = parseFloat(value) || 0;
  let color = "#ef4444"; // Red
  if(score > 40) color = "#f59e0b"; // Orange
  if(score > 75) color = "#10b981"; // Green

  ctx.lineWidth = 20; ctx.strokeStyle = color;
  ctx.beginPath();
  ctx.arc(200, 180, 100, start, start + (score/100)*Math.PI);
  ctx.stroke();
  
  // Score Text
  ctx.font = "bold 32px Inter, sans-serif"; ctx.fillStyle = "#222"; ctx.textAlign = "center";
  ctx.fillText(Math.round(score) + "%", 200, 170);
  ctx.font = "14px Inter, sans-serif"; ctx.fillStyle = "#888";
  ctx.fillText("Readiness", 200, 135);
}

// --- 3. RENDER LOGIC ---
async function start() {
  let payload = window.REPORT_JSON;
  if(!payload) return; // Wait for injection

  const S = payload.solutionSnippets || {};
  const score = parseFloat(payload.score) || 50;

  document.getElementById("studentName").textContent = payload.name || "Future IITian";
  document.getElementById("generatedAt").textContent = new Date().toISOString().split("T")[0];

  let html = "";

  // 1. Executive Summary
  html += `
  <div class="section">
    <h2>Executive Summary</h2>
    ${card("Current Trajectory", "Based on your inputs, your consistency and discipline score is <b>" + score + "/100</b>. " + get(S, "Q1") )}
    
    <div class="graph-row">
      <div class="graph-box">
        <div class="small">Current Reality</div>
        <canvas id="redGraph" width="200" height="180"></canvas>
      </div>
      <div class="graph-box">
        <div class="small">Potential Future</div>
        <canvas id="greenGraph" width="200" height="180"></canvas>
      </div>
    </div>
  </div>`;

  // 2. PCM Strategy
  html += `
  <div class="section">
    <h2>PCM Strategy Analyzer</h2>
    ${card("Physics Strategy", get(S, "Q4"))}
    ${card("Chemistry Strategy", get(S, "Q5"))}
    ${card("Mathematics Strategy", get(S, "Q6"))}
  </div>`;

  // 3. REF & Mindset
  html += `
  <div class="section">
    <h2>REF Study Analyst</h2>
    ${card("Recall Strength", get(S, "Q7"))}
    ${card("Efficiency & Focus", get(S, "Q8") + "<br><br>" + get(S, "Q9"))}
  </div>
  
  <div class="section">
    <h2>Mindset Readiness</h2>
    ${card("Mindset Status", get(S, "Q12"))}
    <div style="margin-top:20px;">
      <canvas id="mindGauge" width="400" height="200" class="speedometer"></canvas>
    </div>
  </div>`;

  // 4. Health & Barriers
  html += `
  <div class="section">
    <h2>Barriers & Health</h2>
    ${card("Biggest Barrier", get(S, "Q11"))}
    ${card("Health & Energy", get(S, "Q13") + "<br><br>" + get(S, "Q14"))}
    ${card("Environment & Support", get(S, "Q15") + "<br><br>" + get(S, "Q16"))}
  </div>`;

  // 5. Conclusion
  html += `
  <div class="section" style="border:none">
    <h2>Conclusion</h2>
    ${card("Final Verdict", "You are capable, but execution is the gap. Fix your routine, improve discipline, and follow the roadmap above. Success is a habit, not a miracle.")}
  </div>`;

  document.getElementById("contentArea").innerHTML = html;

  // Draw Graphs
  drawLineGraph(document.getElementById("redGraph"), "#ef4444", score);
  drawLineGraph(document.getElementById("greenGraph"), "#10b981", Math.min(score + 25, 100));
  drawSpeedometer(score);

  window.__PDF_READY = true;
}

window.onload = start;
</script>
</body>
</html>